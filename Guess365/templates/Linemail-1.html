<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>訂閱mail</title>
    <link rel="stylesheet" href="https://776f-220-130-85-186.jp.ngrok.io/static/css/linemail.css">
    <script src="https://776f-220-130-85-186.jp.ngrok.io/static/js/login.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

   
</head>
<body>
    <div class="mail_bg">
        <!-- logo -->
        <img class="logo" src="https://776f-220-130-85-186.jp.ngrok.io/static/email/logo.png?raw=true" alt="">
        <div class="content_box">

            <!-- 好友募集中 -->
            <img src="https://776f-220-130-85-186.jp.ngrok.io/static/email/subscribe_email.png?raw=true" alt="" class="mail_text">
            <input type="mail"  placeholder="請輸入您的信箱"  class="mail_input" id="mail_input">
            <button type="submit" href="" class="mailSubmit">
              

                <!-- 按鈕 -->
                <img  src="https://776f-220-130-85-186.jp.ngrok.io/static/email/button.png?raw=true" alt="" class="mail_text">
            </button>
            <a href="">
                <p class="linbot_discount">限時加碼！現在訂閱Linebot NBA項目，再多送你8天，共15天訂閱期限，心動不如馬上行動>></p>
            </a>

        </div>
        <!-- 背景圖 -->
        <img src="https://776f-220-130-85-186.jp.ngrok.io/static/email/bc.png?raw=true" alt="" class="pop_bg">
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

    <script>

        //初始化LIFF應用
        function initializeLiff(myLiffId) {
            liff.init({liffId: myLiffId });
        }

        function postData(url, data) {
            return fetch(url, {
                body: JSON.stringify(data),
                headers: {
					'Authorization': 'Basic '+btoa('{{username}}:{{password}}'),
                    'user-agent': 'Mozilla/4.0 MDN Example',
                    'content-type': 'application/json'
                },
                method: 'POST',
                mode: 'cors',
            }).then(response => response.json()) // 輸出成 json
        }


        function pushMsg(str) {
            var msg = str + "/";  //回傳訊息字串
            liff.getProfile()
                    .then((profile) => {
                    const newLineUniqueID = profile.userId;
                    msg = msg + newLineUniqueID;
			        })
                    .then(() => {
                              postData('https://{{domain_name}}/checkemail', { text: msg })
                              .then(data => {
                              if (data['response'] == 'error1'){
                                alert('<br>該信箱已被綁定，請再次確認!!<br><br>');
                                return;
                              } else if (data['response'] == 'error2') {
                                alert('<br>您已綁定過信箱!!<br><br>');
                                return;
                              }
                              } else if (data['response'] == 'success') {
                                alert('<br>恭喜您!!信箱已綁定成功，您的訂閱期限已延長7天囉!!<br><br>');
                                $('#dialog_ok2').click(function (e) {  //按下確定鈕
                                     liff.sendMessages([
                                      {
                                        "type": "text",
                                        "text": "@關於我"
                                      }
                                    ])
                                    .then(() =>{
                                      liff.closeWindow();
                                    })
                                });
                                return;
                              }
                    })
				})
		}


        // 送出按鈕－
        var mailSubmit=document.querySelector('.mailSubmit');


        // 當按下送出會取值
      function mailBtn(value){
        var str ="";
        // 取得input值
        var mialInput=document.getElementById('mail_input').value;

        str=mialInput;

        // 未填寫狀態
        if(str==''){
            alert('請輸入電子信箱');
            document.getElementById('mail_input').focus();
            return false;
        }
        // 有填寫但內容錯誤狀態
        else{
            var mailRegxp=/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/;

            if(mailRegxp.test(str)!=true){
                alert('電子信箱格式錯誤');
                document.getElementById('mail_input').focus();
                document.getElementById('mail_input').select();
                return false;
            }
            // 填寫成功狀態
            else{
                initializeLiff('{{ liffid }}');  //接收傳遞的 liffid 參數
                pushMsg(str);
            }
        }
        // alert(str);
      }
      mailSubmit.addEventListener('click',mailBtn);

     


    </script>
</body>
</html>