<!DOCTYPE html>
<html>
<head>
    <style>
        button{border:0;
              background-color:#003C9D;
              color:#fff;
              border-radius:10px;
              cursor:pointer;
        }

        button:hover{
              color:#fff;
              background-color:#00BFFF;
              border:2px #00BFFF solid;
        }
    </style>
    <title>完成付款通知</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</head>
<body style="text-align:center;">
    <h1 id="LineUserId"></h1>
    <h1> 您的訂單已完成!!</h1>
    <div>
        <h2 id="order"></h2>
    </div>
    <button id="check" style="width:150px;height:50px;">確認訂單</button>

    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script type="application/javascript" src="https://api.ipify.org?format=jsonp&callback=getIP" defer></script>
    <script>

       function initializeLiff(myLiffId) {
            liff.init({liffId: myLiffId });
        }

        function setLabelLineUserId(){
				liff.init({liffId: '{{ liffid }}'})
				.then(() => {
					if (!liff.isLoggedIn()) {
					  liff.login({ redirectUri: location.href })
					  return
					}
					liff.getProfile().then(function (profile) {
						const displayName = profile.displayName;
						document.getElementById('LineUserId').innerHTML = 'Hello! '+displayName;
					}
					)


				  })
				.catch((err) => {
					// Error happens during initialization
					console.log(err.code, err.message);
				});
		}

        function track(){
           //先取得網址字串，假設此頁網址為「index.aspx?id=U001&name=GQSM」
            var url = location.href;

            //再來用去尋找網址列中是否有資料傳遞(QueryString)
            if(url.indexOf('?')!=-1)
            {
                //之後去分割字串把分割後的字串放進陣列中
                var ary1 = url.split('?');
                //此時ary1裡的內容為：
                //ary1[0] = 'index.aspx'，ary1[1] = 'transactionId=U001&orderId=GQSM'

                //下一步把後方傳遞的每組資料各自分割
                var ary2 = ary1[1].split('&');
                //此時ary2裡的內容為：
                //ary2[0] = 'transactionId=U001'，ary2[1] = 'orderId=GQSM'

                //最後如果我們要找id的資料就直接取ary[0]下手，name的話就是ary[1]
                var ary3 = ary2[0].split('=');
                //此時ary3裡的內容為：
                //ary3[0] = 'transactionId'，ary3[1] = 'U001'

                //取得id值
                var transactionId = ary3[1];

                //最後如果我們要找id的資料就直接取ary[0]下手，name的話就是ary[1]
                var ary4 = ary2[1].split('=');
                //此時ary4裡的內容為：
                //ary4[0] = 'orderId'，ary4[1] = 'U001'

                //取得id值
                var orderId = ary4[1];
            }
            document.getElementById('order').innerHTML = "訂單編號為: " + orderId;
            var info = {"transactionId" : transactionId,"orderId" : orderId};
            return info;

        }

        function postData(url, data) {
            return fetch(url, {
                body: JSON.stringify(data),
                headers: {
					'Authorization': 'Basic '+btoa('{{username}}:{{password}}'),
                    'user-agent': 'Mozilla/4.0 MDN Example',
                    'content-type': 'application/json'
                },
                method: 'POST',
                mode: 'cors',
            }).then(response => response.json()) // 輸出成 json
        }

        function orderdata() {
            var info = track();
            var transactionId = info["transactionId"];
            var orderId = info["orderId"];
            var msg =  transactionId + "/";  //回傳訊息字串
            msg = msg + orderId + "/";

            liff.init({liffId: '{{ liffid }}'})
				.then(() => {
                    liff.getProfile()
                        .then((profile) => {
                        const newLineUniqueID = profile.userId;
                        msg = msg + newLineUniqueID;
                        document.getElementById('ch').innerHTML = msg;
                        })
                        .then(() => {
                              postData('https://{{domain_name}}/trackorder', { text: msg })
                              .then(data => {
                                  if (data['response'] == 'success'){
                                      $('#check').click(function (e) {  //按下確定鈕
                                            liff.sendMessages([
                                              {
                                                "type": "text",
                                                "text": "@關於我"
                                              }
                                            ])
                                            .then(() =>{
                                              liff.closeWindow();
                                            })
                                      });
                                      return;
                                  } else if (data['response'] == 'error1') {
                                    document.getElementById('paysc').innerHTML = '訂單不成立';
                                    return;
                                  } else if (data['response'] == 'error2') {
                                    document.getElementById('paysc').innerHTML = '訂單確認錯誤';
                                    return;
                                  } else if (data['response'] == 'error3') {
                                    document.getElementById('paysc').innerHTML = '查無此訂單';
                                    return;
                                  }
                              })
                        })
                })
        }

        setLabelLineUserId();
        orderdata();
	</script>
</body>
</html>